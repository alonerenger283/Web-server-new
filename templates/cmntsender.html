<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comment Sender - Cookie Server</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #0f0f23; min-height: 100vh; }
    .header { background: rgba(23, 23, 40, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 18px 35px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header h1 { font-size: 26px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700; }
    .header-buttons { display: flex; gap: 12px; }
    .btn { padding: 11px 22px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4); }
    .btn-success { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; }
    .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4); }
    .btn-secondary { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.2); }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.15); }
    .container { max-width: 1500px; margin: 30px auto; padding: 0 25px; }
    .posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 22px; margin-bottom: 30px; }
    .post-card { background: rgba(23, 23, 40, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 22px; transition: all 0.3s ease; }
    .post-card:hover { border-color: rgba(102, 126, 234, 0.4); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15); }
    .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .post-title { font-size: 18px; font-weight: 600; color: #ffffff; }
    .post-status { padding: 5px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-running { background: rgba(74, 222, 128, 0.2); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.3); }
    .status-stopped { background: rgba(248, 113, 113, 0.2); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.3); }
    .post-info { margin-bottom: 16px; color: rgba(255, 255, 255, 0.7); font-size: 13px; }
    .post-info div { margin-bottom: 6px; }
    .post-actions { display: flex; gap: 10px; }
    .post-actions button { flex: 1; padding: 10px; font-size: 13px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; overflow-y: auto; }
    .modal-content { background: rgba(23, 23, 40, 0.95); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.1); max-width: 650px; margin: 50px auto; border-radius: 20px; padding: 35px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .modal-header h2 { font-size: 24px; color: #ffffff; }
    .close-btn { font-size: 32px; cursor: pointer; color: rgba(255, 255, 255, 0.5); transition: color 0.3s; }
    .close-btn:hover { color: #f5576c; }
    .form-group { margin-bottom: 22px; }
    .form-group label { display: block; margin-bottom: 10px; color: rgba(255, 255, 255, 0.8); font-weight: 500; font-size: 14px; }
    .form-group input, .form-group textarea { width: 100%; padding: 12px 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; font-size: 14px; font-family: inherit; color: #ffffff; transition: all 0.3s; }
    .form-group input:focus, .form-group textarea:focus { outline: none; background: rgba(255, 255, 255, 0.08); border-color: #667eea; }
    .form-group textarea { resize: vertical; min-height: 110px; }
    .form-group small { display: block; margin-top: 6px; color: rgba(255, 255, 255, 0.5); font-size: 12px; }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 28px; }
    .console-section { background: rgba(23, 23, 40, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 22px; }
    .console-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; gap: 15px; flex-wrap: wrap; }
    .console-header h2 { font-size: 20px; color: #ffffff; margin: 0; }
    .console-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .post-filter-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
    .post-filter-btn { padding: 7px 14px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; color: rgba(255, 255, 255, 0.7); }
    .post-filter-btn:hover { border-color: #667eea; color: #667eea; background: rgba(102, 126, 234, 0.1); }
    .post-filter-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: transparent; }
    .console-logs { background: rgba(10, 10, 18, 0.8); color: #eee; padding: 18px; border-radius: 12px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; max-height: 650px; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.05); }
    .console-log-item { margin-bottom: 14px; padding: 16px; background: rgba(30, 33, 62, 0.6); border-radius: 10px; border-left: 4px solid #4ade80; white-space: pre-line; line-height: 1.7; }
    .console-log-item.failed { border-left-color: #f87171; background: rgba(40, 30, 30, 0.6); }
    .console-log-item.info { border-left-color: #60a5fa; background: rgba(30, 42, 62, 0.6); }
    .log-postid { color: #34d399; font-weight: bold; }
    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-account { color: #a78bfa; }
    .log-label { color: #94a3b8; }
    .log-value { color: #f1f5f9; }
    .confirm-dialog { background: rgba(23, 23, 40, 0.95); backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.1); max-width: 420px; margin: 200px auto; border-radius: 20px; padding: 30px; text-align: center; }
    .confirm-dialog h3 { margin-bottom: 18px; color: #ffffff; font-size: 22px; }
    .confirm-dialog p { margin-bottom: 24px; color: rgba(255, 255, 255, 0.7); }
    .confirm-actions { display: flex; gap: 12px; justify-content: center; }
    .empty-state { text-align: center; padding: 70px 20px; color: rgba(255, 255, 255, 0.5); }
    .empty-state h3 { margin-bottom: 12px; color: rgba(255, 255, 255, 0.7); font-size: 20px; }
    .auto-refresh-toggle { display: flex; align-items: center; gap: 10px; }
    .auto-refresh-toggle label { font-size: 13px; color: rgba(255, 255, 255, 0.7); cursor: pointer; }
    .auto-refresh-toggle input { cursor: pointer; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üí¨ Comment Sender</h1>
    <div class="header-buttons">
      <button class="btn btn-primary" onclick="createNewPost()">Create New Post</button>
      <button class="btn btn-secondary" onclick="window.location.href='/dashboard'">‚Üê Back</button>
    </div>
  </div>

  <div class="container">
    <div class="posts-grid" id="postsGrid"></div>
    
    <div class="console-section">
      <div class="console-header">
        <h2>üìã Console</h2>
        <div class="console-controls">
          <div class="post-filter-buttons" id="postFilterButtons">
            <button class="post-filter-btn active" data-post="all">All Posts</button>
          </div>
          <div class="auto-refresh-toggle">
            <input type="checkbox" id="autoRefresh">
            <label for="autoRefresh">Auto Refresh</label>
          </div>
          <button class="btn btn-secondary" onclick="refreshLogs()">Refresh</button>
        </div>
      </div>
      <div class="console-logs" id="consoleLogs">
        <div class="console-log-item info">‚è≥ Waiting for activity...</div>
      </div>
    </div>
  </div>

  <div class="modal" id="configModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Configure Post</h2>
        <span class="close-btn" onclick="closeConfigModal()">&times;</span>
      </div>
      <form id="configForm">
        <div class="form-group">
          <label>Cookies (one per line)</label>
          <textarea id="cookiesInput" placeholder="Enter cookies, one per line"></textarea>
          <small>Paste your Facebook account cookies here</small>
        </div>
        <div class="form-group">
          <label>Post ID</label>
          <input type="text" id="postIdInput" placeholder="1234567890">
          <small>The Facebook post ID to comment on</small>
        </div>
        <div class="form-group">
          <label>Comments (one per line)</label>
          <textarea id="commentsInput" placeholder="Enter comments, one per line"></textarea>
          <small>Comments will be sent in sequence</small>
        </div>
        <div class="form-group">
          <label>Short Text (Optional)</label>
          <input type="text" id="shortInput" placeholder="Prefix text">
          <small>This text will be added before each comment</small>
        </div>
        <div class="form-group">
          <label>Timer (seconds)</label>
          <input type="number" id="timerInput" min="40" value="40">
          <small>Delay between comments (minimum 40 seconds)</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
          <button type="submit" class="btn btn-success">Save & Start</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="deleteModal">
    <div class="confirm-dialog">
      <h3>Delete Post</h3>
      <p>Are you sure you want to delete this post configuration? This action cannot be undone.</p>
      <div class="confirm-actions">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    let currentPostId = null;
    let deleteTargetPostId = null;
    let selectedPostFilter = 'all';
    let allLogEntries = [];
    let autoRefreshInterval = null;

    async function loadPosts() {
      try {
        const response = await fetch('/api/cmnts');
        const posts = await response.json();
        const grid = document.getElementById('postsGrid');
        grid.innerHTML = '';
        
        if (Object.keys(posts).length === 0) {
          grid.innerHTML = '<div class="empty-state"><h3>No Posts Yet</h3><p>Click "Create New Post" to get started</p></div>';
          updatePostFilterButtons([]);
          return;
        }
        
        for (const [postId, post] of Object.entries(posts)) {
          grid.appendChild(createPostCard(postId, post));
        }
        updatePostFilterButtons(Object.keys(posts));
      } catch (e) { console.error('Error loading posts:', e); }
    }

    function updatePostFilterButtons(postIds) {
      const container = document.getElementById('postFilterButtons');
      container.innerHTML = '<button class="post-filter-btn active" data-post="all" onclick="filterLogs(\'all\')">All Posts</button>';
      postIds.forEach(postId => {
        const btn = document.createElement('button');
        btn.className = 'post-filter-btn';
        btn.setAttribute('data-post', postId);
        btn.textContent = postId;
        btn.onclick = () => filterLogs(postId);
        container.appendChild(btn);
      });
    }

    function filterLogs(postId) {
      selectedPostFilter = postId;
      document.querySelectorAll('.post-filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-post') === postId);
      });
      displayFilteredLogs();
    }

    function formatLogEntry(log) {
      const isSuccess = log.message.includes('‚úì');
      const isFailed = log.message.includes('‚úó');
      const isInfo = !isSuccess && !isFailed;
      
      let className = 'console-log-item';
      if (isFailed) className += ' failed';
      else if (isInfo) className += ' info';
      
      const lines = log.message.split('\n');
      let html = `<span class="log-postid">[${log.postId}]</span>\n`;
      
      lines.forEach(line => {
        if (line.startsWith('‚úì')) {
          html += `<span class="log-success">${line}</span>\n`;
        } else if (line.startsWith('‚úó')) {
          html += `<span class="log-error">${line}</span>\n`;
        } else if (line.startsWith('Account:')) {
          html += `<span class="log-label">Account:</span> <span class="log-account">${line.replace('Account:', '').trim()}</span>\n`;
        } else {
          html += `<span class="log-value">${line}</span>\n`;
        }
      });
      
      return { className, html };
    }

    function displayFilteredLogs() {
      const consoleLogs = document.getElementById('consoleLogs');
      consoleLogs.innerHTML = '';
      
      let filteredLogs = selectedPostFilter === 'all' ? allLogEntries : allLogEntries.filter(l => l.postId === selectedPostFilter);
      
      if (filteredLogs.length === 0) {
        consoleLogs.innerHTML = '<div class="console-log-item info">‚è≥ No activity yet</div>';
        return;
      }
      
      filteredLogs.forEach(log => {
        const { className, html } = formatLogEntry(log);
        const logItem = document.createElement('div');
        logItem.className = className;
        logItem.innerHTML = html;
        consoleLogs.appendChild(logItem);
      });
      
      consoleLogs.scrollTop = 0;
    }

    async function refreshLogs() {
      try {
        const response = await fetch('/api/cmnts');
        const posts = await response.json();
        allLogEntries = [];
        
        for (const postId of Object.keys(posts)) {
          try {
            const logResponse = await fetch(`/api/cmnts/${postId}/logs`);
            const logData = await logResponse.json();
            if (logData.logs?.length > 0) {
              logData.logs.forEach(log => {
                allLogEntries.push({
                  ...log,
                  postId: log.postId || postId,
                  timestamp: new Date(log.time).getTime()
                });
              });
            }
          } catch (e) { console.error(`Error fetching logs for ${postId}:`, e); }
        }
        
        allLogEntries.sort((a, b) => b.timestamp - a.timestamp);
        displayFilteredLogs();
      } catch (e) { console.error('Error refreshing logs:', e); }
    }

    function createPostCard(postId, post) {
      const card = document.createElement('div');
      card.className = 'post-card';
      const statusClass = post.running ? 'status-running' : 'status-stopped';
      const statusText = post.running ? 'Running' : 'Stopped';
      
      card.innerHTML = `
        <div class="post-header">
          <div class="post-title">${postId}</div>
          <div class="post-status ${statusClass}">${statusText}</div>
        </div>
        <div class="post-info">
          <div>Accounts: ${post.cookies.length}</div>
          <div>Comments: ${post.comments.length}</div>
          <div>Timer: ${post.timer}s</div>
          <div>Post ID: ${post.postid || 'Not set'}</div>
        </div>
        <div class="post-actions">
          ${post.running 
            ? `<button class="btn btn-danger" onclick="stopPost('${postId}')">Stop</button>`
            : `<button class="btn btn-success" onclick="startPost('${postId}')">Start</button>`}
          <button class="btn btn-primary" onclick="configurePost('${postId}')">Configure</button>
          <button class="btn btn-danger" onclick="showDeleteConfirm('${postId}')">Delete</button>
        </div>`;
      return card;
    }

    async function createNewPost() {
      try {
        const response = await fetch('/api/cmnts/create', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          await loadPosts();
          configurePost(data.postId);
        }
      } catch (e) { console.error('Error creating post:', e); }
    }

    async function configurePost(postId) {
      currentPostId = postId;
      try {
        const response = await fetch('/api/cmnts');
        const posts = await response.json();
        const post = posts[postId];
        
        if (post) {
          document.getElementById('cookiesInput').value = post.cookies.join('\n');
          document.getElementById('postIdInput').value = post.postid;
          document.getElementById('commentsInput').value = post.comments.join('\n');
          document.getElementById('shortInput').value = post.short;
          document.getElementById('timerInput').value = post.timer;
        }
        document.getElementById('configModal').style.display = 'block';
      } catch (e) { console.error('Error loading post config:', e); }
    }

    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const cookies = document.getElementById('cookiesInput').value.split('\n').map(c => c.trim()).filter(c => c);
      const postid = document.getElementById('postIdInput').value.trim();
      const comments = document.getElementById('commentsInput').value.split('\n').map(m => m.trim()).filter(m => m);
      const short = document.getElementById('shortInput').value.trim();
      const timer = Math.max(40, parseInt(document.getElementById('timerInput').value) || 40);
      
      try {
        const response = await fetch(`/api/cmnts/${currentPostId}/configure`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookies, postid, comments, short, timer })
        });
        
        const data = await response.json();
        if (data.success) {
          closeConfigModal();
          await fetch(`/api/cmnts/${currentPostId}/start`, { method: 'POST' });
          await loadPosts();
          refreshLogs();
        }
      } catch (e) { console.error('Error saving config:', e); }
    });

    async function startPost(postId) {
      try {
        await fetch(`/api/cmnts/${postId}/start`, { method: 'POST' });
        await loadPosts();
        refreshLogs();
      } catch (e) { console.error('Error starting post:', e); }
    }

    async function stopPost(postId) {
      try {
        await fetch(`/api/cmnts/${postId}/stop`, { method: 'POST' });
        await loadPosts();
      } catch (e) { console.error('Error stopping post:', e); }
    }

    function showDeleteConfirm(postId) {
      deleteTargetPostId = postId;
      document.getElementById('deleteModal').style.display = 'block';
    }

    async function confirmDelete() {
      if (!deleteTargetPostId) return;
      try {
        await fetch(`/api/cmnts/${deleteTargetPostId}`, { method: 'DELETE' });
        closeDeleteModal();
        await loadPosts();
      } catch (e) { console.error('Error deleting post:', e); }
    }

    function closeConfigModal() {
      document.getElementById('configModal').style.display = 'none';
      currentPostId = null;
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      deleteTargetPostId = null;
    }

    function setupAutoRefresh() {
      const checkbox = document.getElementById('autoRefresh');
      if (checkbox.checked) {
        autoRefreshInterval = setInterval(() => {
          refreshLogs();
          loadPosts();
        }, 30000);
      }
      
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          autoRefreshInterval = setInterval(() => {
            refreshLogs();
            loadPosts();
          }, 30000);
        } else {
          clearInterval(autoRefreshInterval);
        }
      });
    }

    loadPosts();
    refreshLogs();
    setupAutoRefresh();
  </script>
</body>
</html>
